# 개발 진행)
1. 설계/요구사항 정리, ssh-cmd.sh 코드 구현 <---
2. bash_completion 
3. man 페이지/문서화

# 의존성 목록
- ssh, ssh-keygen
- jq
- md5sum

# 코드 작성방법
1. 코드 수정이 간단한 경우 내가 직접할 수 있도록 
  수정되는 코드의 "수정 전 / 수정 후" 위치와 내용을 명확히 작성하고.
  수정할 코드가 너무 많은 경우는 전체 코드를 제공한다.

# 개발요구서 작성방법
1. 개발요구서(SR_v1.y.z)는 v1.x.y을 기준으로 '추가/수정/삭제'된 내용만 새로 작성하고, 전체 문서를 **다시** 작성한다.
  작성 기준은 아래 내용을 따른다.
  0. 1.x.y의 "개요&목차" 구조는 절대적으로 유지한다.
  1. 변경사항이 발생하지 않은 내용은 그대로 유지한다. 
  2. 새로 추가된 부분은 새로운 목록를 추가해서 작성한다.
  3. "13. Changelog" 챕터에 변경사항을 기록한다.
    * "Changelog" 내용은 `<버전> <일자> <시간>` 순서로 내림차순으로 정렬한다.

# 보안설계문서 작성방법
1. 보안설계문서(SR_v1.y.z)는 v1.x.y 을 근거으로 작성한다.
  - 개발요구서(SR_v1.x.y)의 문서구조처럼 "목차(바로가기)"를 작성한다.
  - v1.0.0 내용을 근거로 최종적으로 결정된 내용을 작성한다.
  - 마지막 챕터를 "Changelog"로 정하고 변경사항을 기록한다.
    * "Changelog" 내용은 `<버전> <일자> <시간>` 순서로 내림차순으로 정렬한다.
    * 작성예시
    ```
    * `v1.1.0`;2025-12-10 16:54
      * ...
        * ...
          * ...
        * ...
      * ...
    * `v1.0.0`;2025-12-09 12:12
      * .

# 최신 업로드 파일명
- ssh-cmd-v4.sh: 프로그램 코드
- ssh-cmd-개발요구사항-SR_v1.8.4: 개발요구사항 문서
- ssh-cmd-보안설계-SR_v1.0.0: 보안설계 문서

>>> Q-202512012-003

업로드한 현재 파일들을 기준으로 아래 내용을 진행합니다.

# 최신 업로드 파일명
- ssh-cmd-v4.sh: 프로그램 코드
- ssh-cmd-개발요구사항-SR_v1.8.4: 개발요구사항 문서
- ssh-cmd-보안설계-SR_v1.0.0: 보안설계 문서

# 용어정리
- **민감정보**: username, credential

# 1. 개발기능
- '민감정보'에 대해서 다음와 같은 기능에 대해서 'OpenSSH Private Key' 기반의 암/복호화를 적용합니다.
  - '연결정보' 읽기: 복호화
    - 명령어: --list-all | -l
  - '연결정보' 생성: 암호화
    - 명령어: --add-connection | -a
  - '연결정보' 수정: 복호화(읽을 때), 암호화(저장할 때)
    - 명령어: --modify-connection | -m

# 코드 작성방법
1. 코드 수정이 간단한 경우 내가 직접할 수 있도록 
  수정되는 코드의 "수정 전 / 수정 후" 위치와 내용을 명확히 작성하고.
  수정할 코드가 너무 많은 경우는 전체 코드를 제공한다.

# 개발요구서 작성방법
2. 개발요구서(SR_v1.8.5)는 v1.8.4을 기준으로 '추가/수정/삭제'된 내용만 새로 작성하고, 전체 문서를 **다시** 작성한다.
  작성 기준은 아래 내용을 따른다.
  0. 1.8.4의 "개요&목차" 구조는 절대적으로 유지한다. 
  1. 변경사항이 발생하지 않은 내용은 그대로 유지한다.
    - "12. 보안 및 권한" 챕터에 '민감정보' 암/복호화 내용을 작성한다.
    - "13. Changelog" 챕터에 변경사항을 기록한다.
      * "Changelog" 내용은 `<버전> <일자> <시간>` 순서로 내림차순으로 정렬한다.
# 보안설계문서 작성방법
1. 보안설계문서(SR_v1.1.0)는 v1.0.0을 근거으로 작성한다.
  - 개발요구서(SR_v1.8.4)의 문서구조처럼 "목차(바로가기)"를 작성한다.
  - v1.0.0 내용을 근거로 최종적으로 결정된 내용을 작성한다.
  - 마지막 챕터를 "Changelog"로 정하고 변경사항을 기록한다.
    * "Changelog" 내용은 `<버전> <일자> <시간>` 순서로 내림차순으로 정렬한다.
    * 작성예시
    ```
    * `v1.1.0`;2025-12-10 16:54
      * ...
        * ...
          * ...
        * ...
      * ...
    * `v1.0.0`;2025-12-09 12:12
      * ....
    ```



  
>>> Q-20251210-002
# 1. 개선사항
- 'open ssh private key' 파일 검증
  1. 프로그램 내 변수이 ${MASTERKEY_FILE} 값에 해당하는 파일이 없는 경우
    - 'open ssh private key' 파일 생성 진행
      - 중간에 비밀번호를 입력하는 부분은 사용자와 interaction 진행
  2. ${MASTERKEY_FILE} 파일의 md5 값과 configuration.masterkey_md5 값이 비교 결과에 따라 처리
    - 'configuration' 파일이 없는 경우: 'configuration' 파일 생성 후 'configuration.masterkey_md5'에 ${MASTERKEY_FILE} 파일의 md5 값 설정 후 정상적으로 진행
    - 'configuration.masterkey_md5' 정보가 없는 경우: ${MASTERKEY_FILE} 파일의 md5 값 설정 후 정상적으로 진행
    - 'configuration.masterkey_md5' 의 값과 ${MASTERKEY_FILE} 파일의 md5 값이 동일한 경우: 정상적으로 진행
    - 'configuration.masterkey_md5' 의 값과 ${MASTERKEY_FILE} 파일의 md5 값이 다른 경우: 
      1. 오류 메시지를 출력하고 (아래는 오류 메시지 포맷)
        ```
        ============================================================================
        ⚙️ masterkey_file              : <open ssh private key 경로>
        ⚙️ masterkey_file.md5          : <open ssh private key 파일>의 md5 값
        ⚙️ configuration.masterkey_md5 : <configuration.masterkey_md5> 값
        ============================================================================  
        ```
      2. 새로운 'masterkey_file' 경로를 입력받아, 다시 한번 비교 과정을 진행
        - 입력받은 'masterkey_file' 경로에 대해서는 파일존재유무를 검증
      3. 새로 입력받은 'masterkey_file' 파일와 md5 값이 일치하면, MASTERKEY_FILE 값을 새로 입력받은 'masterkey_file' 값으로 갱신하고 이후 진행.

너가 제안한 'ensure_masterkey_md5()' 함수를 "1. 개선사항"을 만족하도록 수정해 줘.

'ensure_masterkey_md5() 함수 코드'
```
##
# configuration.masterkey_md5 와 실제 MASTERKEY_FILE md5 를 비교해 정합성을 검증한다.
# Verify consistency between configuration.masterkey_md5 and actual MASTERKEY_FILE md5.
#
# @param $1 없음 / none
#
# @return {int} 성공 시 0, 정합성 실패 시 die() 를 통해 종료
#         0 on success; terminates via die() on mismatch.
##
ensure_masterkey_md5() {
  # masterkey 파일이 없으면 아직 masterkey 기반 암호화 미사용으로 간주하고 통과
  if [[ ! -f "${MASTERKEY_FILE}" ]]; then
    return 0
  fi

  local file_md5
  file_md5="$(md5sum "${MASTERKEY_FILE}" | awk '{print $1}')"

  # configuration 안의 masterkey_md5 읽기 (없으면 빈 문자열)
  local config_md5
  config_md5="$(jq -r '.masterkey_md5 // ""' "${CONFIG_FILE}" 2>/dev/null || echo "")"

  # 설정 파일에 값이 없거나 null 이면 → 현재 md5 를 기록 (초기 1회 마이그레이션)
  if [[ -z "${config_md5}" || "${config_md5}" == "null" ]]; then
    local tmp
    tmp="$(mktemp "${CONFIG_FILE}.XXXXXX")"
    jq --arg md5 "${file_md5}" '.masterkey_md5 = $md5' "${CONFIG_FILE}" > "${tmp}"
    mv "${tmp}" "${CONFIG_FILE}"
    chmod 600 "${CONFIG_FILE}" || true
    return 0
  fi

  # 값이 있는데 서로 다르면 정합성 실패
  if [[ "${config_md5}" != "${file_md5}" ]]; then
    die "configuration(masterkey_md5=${config_md5}) and MASTERKEY_FILE(${MASTERKEY_FILE}) md5(${file_md5}) mismatch."
  fi

  return 0
}
```

>>> Q-20251210-001
# 1. 수정사항 
- 'configuration' 데이터 모델
  - 신규 추가
    - masterkey_md5: masterkey 파일의 md5 값. 이 값을 이용해서 설정파일(configuration)과 'open ssh private key'와 정합성을 검증함.
    - 프로그램 실행시 'masterkey_md5' 값과 'open ssh private key' 파일의 md5 값을 비교함.
- 'connection' 데이터 모델
  - 이름 변경
    - user -> username
- 보안설계
  - 민감정보: username, credential 
    - host, port 제외

# 2. 신규사항
- 설정정보 노출
  - 프로그램 실행시 무조건 '연결정보파일 경로'와 'open ssh private key' 경로를 제공.
  - '연결정보' 이전에 표기하며, 표기방식은 아래와 같음.
  ```
  ============================================================================
  ⚙️ configuration: <연결정보파일 경로>
  ⚙️ masterkey: <open ssh private key 경로>
  ============================================================================
  Group     Name            Host                     Port  User     Credential
  ----------------------------------------------------------------------------
  default   사내 통합 ERP   erp.mycompany.co.kr         22    mycompany   ****************
  com#1     com             gitlab.mycompany.co.kr      22    mycompany   ****************
  ============================================================================
  ```
- 신규 옵션
  - --masterkey: '민감정보' 암/복호화에 사용될 'open ssh private key 파일 경로'
- 전역환경변수 정의
  - 사용자 가이드에 추가할 것.
    - SSH_CMD_CONFIG: '연결정보파일 경로'
      - 우선순위
        1. --config 옵션으로 전달되는 값
        2. 정의되어 있다면 SSH_CMD_CONFIG 전역변수 값
        3. ${HOME}/.ssh-cmd/configuration
    - SSH_CMD_MASTERKEY: '민감정보' 암호화/난독화에 사용되는 'open ssh private key'
      - 우선순위
        1. --masterkey 옵션으로 전달되는 값. (--masterkey는 신규 추가 예정)
        2. 정의되어 있다면 SSH_CMD_MASTERKEY 전역변수 값
        3. ${HOME}/.ssh-cmd/masterkey      


