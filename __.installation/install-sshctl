#!/usr/bin/env bash
#
# SSHCTL ë° SSHCTL.COMPLETION, man í˜ì´ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì„¤ì¹˜í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
# - sshctl ì‹¤í–‰ íŒŒì¼ì€ í•­ìƒ ì„¤ì¹˜
# - -y ì˜µì…˜ì´ ìˆìœ¼ë©´: completion + man pages(1/5/7)ë¥¼ ì§ˆë¬¸ ì—†ì´ ì„¤ì¹˜
# - -y ì˜µì…˜ì´ ì—†ìœ¼ë©´: completion + man pages(1/5/7)ë¥¼ ì„¤ì¹˜í• ì§€ ê°œë³„ í™•ì¸
#

# ----------------------------------------------------------------------
# í”„ë¡œê·¸ë¨ íŒŒì¼ ì´ë¦„
# ----------------------------------------------------------------------
SSHCTL_FILENAME="sshctl"
SSHCTL_COMPLETION_FILENAME="${SSHCTL_FILENAME}.completion"

# ----------------------------------------------------------------------
# ëª…ë ¹í–‰ ì˜µì…˜ ì²˜ë¦¬ (-y)
# ----------------------------------------------------------------------
ASSUME_YES=0

while getopts ":y" opt; do
  case "${opt}" in
    y)
      ASSUME_YES=1
      ;;
    \?)
      echo "ì‚¬ìš©ë²•: $0 [-y]" >&2
      exit 1
      ;;
  esac
done
shift $((OPTIND - 1))

# ----------------------------------------------------------------------
# ì›ê²© URL ì •ì˜ (sshctl / completion / man pages)
# ----------------------------------------------------------------------
SSHCTL_SCRIPT_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/net/sshctl/${SSHCTL_FILENAME}"
SSHCTL_COMPLETION_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/net/sshctl/${SSHCTL_COMPLETION_FILENAME}"

# man page ì›ê²© ê²½ë¡œ
SSHCTL_MAN1_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/__.man/1/sshctl.1"
SSHCTL_MAN5_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/__.man/5/sshctl-conf.5"
SSHCTL_MAN7_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/__.man/7/sshctl-security.7"

# ----------------------------------------------------------------------
# ì„¤ì¹˜ ê²½ë¡œ ì •ì˜
# ----------------------------------------------------------------------
# sshctl ì‹¤í–‰ íŒŒì¼ ì„¤ì¹˜ ê²½ë¡œ
SSHCTL_TARGET_DIR="${HOME}/bin"

# bash completion ì„¤ì¹˜ ê²½ë¡œ
COMPLETION_TARGET_DIR="/etc/bash_completion.d"

# man í˜ì´ì§€ ì„¤ì¹˜ ê²½ë¡œ (ì„¹ì…˜ë³„)
MAN1_TARGET_DIR="/usr/local/share/man/man1"
MAN5_TARGET_DIR="/usr/local/share/man/man5"
MAN7_TARGET_DIR="/usr/local/share/man/man7"

# ----------------------------------------------------------------------
# ì„ì‹œ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ê²½ë¡œ
# ----------------------------------------------------------------------
TEMP_DIR="$(mktemp -d)"
SSHCTL_TEMP_FILE="${TEMP_DIR}/${SSHCTL_FILENAME}"
COMPLETION_TEMP_FILE="${TEMP_DIR}/${SSHCTL_COMPLETION_FILENAME}"
MAN1_TEMP_FILE="${TEMP_DIR}/sshctl.1"
MAN5_TEMP_FILE="${TEMP_DIR}/sshctl-conf.5"
MAN7_TEMP_FILE="${TEMP_DIR}/sshctl-security.7"

# man DB ê°±ì‹  ì—¬ë¶€
INSTALLED_MAN=0

# ----------------------------------------------------------------------
# ê³µí†µ ìœ í‹¸ í•¨ìˆ˜ë“¤
# ----------------------------------------------------------------------

cleanup() {
  if [[ -d "${TEMP_DIR}" ]]; then
    echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬: ${TEMP_DIR}"
    rm -rf "${TEMP_DIR}"
  fi
}
trap cleanup EXIT

check_dependencies() {
  if command -v curl >/dev/null 2>&1; then
    DOWNLOADER="curl -fsSL"
  elif command -v wget >/dev/null 2>&1; then
    DOWNLOADER="wget -qO-"
  else
    echo "âŒ í•„ìˆ˜ ë„êµ¬ (curl ë˜ëŠ” wget)ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." >&2
    exit 1
  fi
}

##
# ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„± (í•„ìš” ì‹œ sudo)
#
# @param $1 {string} target_dir ìƒì„±/ë³´ì¥í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ
##
ensure_dir() {
  local target_dir="$1"

  if [[ -d "${target_dir}" ]]; then
    return 0
  fi

  if mkdir -p "${target_dir}" 2>/dev/null; then
    return 0
  else
    echo "  â„¹ï¸  ë””ë ‰í† ë¦¬(${target_dir}) ìƒì„±ì— sudo ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."
    if command -v sudo >/dev/null 2>&1; then
      sudo mkdir -p "${target_dir}" || {
        echo "  âŒ ë””ë ‰í† ë¦¬(${target_dir}) ìƒì„± ì‹¤íŒ¨." >&2
        return 1
      }
    else
      echo "  âŒ sudo ê°€ ì—†ì–´ ë””ë ‰í† ë¦¬(${target_dir})ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >&2
      return 1
    fi
  fi
}

##
# íŒŒì¼ ë³µì‚¬ ë° (í•„ìš” ì‹œ) ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
#
# @param $1 {string} source_file          ë³µì‚¬í•  ì›ë³¸ íŒŒì¼
# @param $2 {string} target_dir           ëŒ€ìƒ ë””ë ‰í† ë¦¬
# @param $3 {string} filename             ëŒ€ìƒ íŒŒì¼ ì´ë¦„
# @param $4 {string} needs_exec_permission "true" ì´ë©´ chmod +x ìˆ˜í–‰
##
copy_and_set_permissions() {
  local source_file="$1"
  local target_dir="$2"
  local filename="$3"
  local needs_exec_permission="$4"

  ensure_dir "${target_dir}" || return 1

  local final_dest_path="${target_dir}/${filename}"

  local cp_cmd="cp"
  if [[ -e "${final_dest_path}" && ! -w "${final_dest_path}" ]]; then
    cp_cmd="sudo cp"
  elif [[ ! -e "${final_dest_path}" && ! -w "${target_dir}" ]]; then
    cp_cmd="sudo cp"
  fi

  echo "  ğŸ“ ${source_file} â†’ ${final_dest_path} ë³µì‚¬ ì¤‘..."
  ${cp_cmd} "${source_file}" "${final_dest_path}"
  if [[ $? -ne 0 ]]; then
    echo "  âŒ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨: ${source_file} â†’ ${final_dest_path}" >&2
    return 1
  fi
  echo "  âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"

  if [[ "${needs_exec_permission}" == "true" ]]; then
    local chmod_cmd="chmod +x"
    if [[ ! -w "${final_dest_path}" ]]; then
      chmod_cmd="sudo chmod +x"
    fi

    echo "  ğŸ”‘ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì¤‘..."
    ${chmod_cmd} "${final_dest_path}"
    if [[ $? -ne 0 ]]; then
      echo "  âŒ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì‹¤íŒ¨: ${final_dest_path}" >&2
      return 1
    fi
    echo "  âœ… ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì™„ë£Œ"
  fi

  return 0
}

##
# URL ë¡œë¶€í„° íŒŒì¼ ë‹¤ìš´ë¡œë“œ
#
# @param $1 {string} url    ë‹¤ìš´ë¡œë“œ URL
# @param $2 {string} target ì €ì¥í•  ë¡œì»¬ ê²½ë¡œ
# @param $3 {string} label  ë¡œê·¸ìš© ì´ë¦„
##
download_file() {
  local url="$1"
  local target="$2"
  local label="$3"

  echo "  âš™ï¸  ${label} ë‹¤ìš´ë¡œë“œ ì¤‘: ${url}"
  ${DOWNLOADER} "${url}" > "${target}"
  if [[ $? -ne 0 || ! -s "${target}" ]]; then
    echo "  âŒ ${label} ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨." >&2
    return 1
  fi
  echo "  âœ… ${label} ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
  return 0
}

##
# sshctl ì„¤ì¹˜ (í•­ìƒ ìˆ˜í–‰)
##
install_sshctl() {
  echo "--------------------------------------------------"
  echo "ğŸ“¦ sshctl ì„¤ì¹˜ ê²½ë¡œ: ${SSHCTL_TARGET_DIR}"

  download_file "${SSHCTL_SCRIPT_URL}" "${SSHCTL_TEMP_FILE}" "sshctl" || return 1
  copy_and_set_permissions "${SSHCTL_TEMP_FILE}" "${SSHCTL_TARGET_DIR}" "${SSHCTL_FILENAME}" "true" || return 1

  echo "  â„¹ï¸  PATH ì— ${SSHCTL_TARGET_DIR} ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
  echo "     ì˜ˆ) export PATH=\"${SSHCTL_TARGET_DIR}:\$PATH\""

  return 0
}

##
# ì‚¬ìš©ìì—ê²Œ ì„¤ì¹˜ ì—¬ë¶€ ì§ˆë¬¸ (ASSUME_YES==1 ì´ë©´ ìë™ yes)
#
# @param $1 {string} prompt_text ì§ˆë¬¸ ë¬¸êµ¬
# @return 0(install) / 1(skip)
##
ask_install() {
  local prompt_text="$1"

  if (( ASSUME_YES == 1 )); then
    echo "  ğŸ” -y ì˜µì…˜ ì‚¬ìš©: ${prompt_text} â†’ ìë™ìœ¼ë¡œ 'ì˜ˆ'ë¡œ ì²˜ë¦¬í•©ë‹ˆë‹¤."
    return 0
  fi

  echo -n "  â“ ${prompt_text} [y/N]: "
  read -r answer

  case "${answer}" in
    [yY]|[yY][eE][sS])
      return 0
      ;;
    *)
      echo "  â­ ì„¤ì¹˜ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."
      return 1
      ;;
  esac
}

##
# bash completion ì„¤ì¹˜ (ì¡°ê±´ë¶€)
##
maybe_install_completion() {
  echo "--------------------------------------------------"
  echo "ğŸ“¦ sshctl bash completion ì„¤ì¹˜"

  if ! ask_install "sshctl bash completion íŒŒì¼ì„ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; then
    return 0
  fi

  download_file "${SSHCTL_COMPLETION_URL}" "${COMPLETION_TEMP_FILE}" "sshctl.completion" || {
    echo "  âš ï¸ completion ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì„¤ì¹˜ ê±´ë„ˆëœ€)" >&2
    return 0
  }

  copy_and_set_permissions "${COMPLETION_TEMP_FILE}" "${COMPLETION_TARGET_DIR}" "${SSHCTL_COMPLETION_FILENAME}" "false" || {
    echo "  âš ï¸ completion ì„¤ì¹˜ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰)" >&2
    return 0
  }

  echo "  â„¹ï¸  bash ì—ì„œ ìë™ì™„ì„±ì„ í™œì„±í™”í•˜ë ¤ë©´ í„°ë¯¸ë„ì„ ìƒˆë¡œ ì—´ê±°ë‚˜,"
  echo "     ë‹¤ìŒ ëª…ë ¹ ì¤‘ í•˜ë‚˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:"
  echo "       - source ~/.bashrc"
  echo "       - source ${COMPLETION_TARGET_DIR}/${SSHCTL_COMPLETION_FILENAME}"

  return 0
}

##
# ë‹¨ì¼ man í˜ì´ì§€ ì„¤ì¹˜ (ì¡°ê±´ë¶€)
#
# @param $1 {string} section     ì„¹ì…˜ ë²ˆí˜¸(1/5/7)
# @param $2 {string} url         ë‹¤ìš´ë¡œë“œ URL
# @param $3 {string} temp_file   ì„ì‹œ íŒŒì¼ ê²½ë¡œ
# @param $4 {string} target_dir  ì„¤ì¹˜ ë””ë ‰í† ë¦¬
# @param $5 {string} filename    ì„¤ì¹˜ íŒŒì¼ëª… (ì˜ˆ: sshctl.1)
# @param $6 {string} desc        ì„¤ëª…(ì˜ˆ: "sshctl.1 (ê¸°ë³¸ ëª…ë ¹ man í˜ì´ì§€)")
##
maybe_install_man() {
  local section="$1"
  local url="$2"
  local temp_file="$3"
  local target_dir="$4"
  local filename="$5"
  local desc="$6"

  echo "--------------------------------------------------"
  echo "ğŸ“š man í˜ì´ì§€ ì„¤ì¹˜: ${desc}"

  if ! ask_install "${desc} ë¥¼ ì„¤ì¹˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; then
    return 0
  fi

  download_file "${url}" "${temp_file}" "${filename}" || {
    echo "  âš ï¸ ${filename} ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ (ì„¤ì¹˜ ê±´ë„ˆëœ€)" >&2
    return 0
  }

  copy_and_set_permissions "${temp_file}" "${target_dir}" "${filename}" "false" || {
    echo "  âš ï¸ ${filename} ì„¤ì¹˜ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰)" >&2
    return 0
  }

  INSTALLED_MAN=1
  return 0
}

##
# man DB ê°±ì‹  (í•„ìš” ì‹œ)
##
update_man_db_if_needed() {
  if (( INSTALLED_MAN == 0 )); then
    return 0
  fi

  if command -v mandb >/dev/null 2>&1; then
    echo "--------------------------------------------------"
    echo "  ğŸ”„ man DB ê°±ì‹  ì¤‘ (mandb)..."
    if mandb >/dev/null 2>&1; then
      echo "  âœ… man DB ê°±ì‹  ì™„ë£Œ"
    else
      echo "  âš ï¸ mandb ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆì§€ë§Œ, man í˜ì´ì§€ëŠ” íŒŒì¼ ìˆ˜ì¤€ì—ì„œëŠ” ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤." >&2
    fi
  else
    echo "--------------------------------------------------"
    echo "  â„¹ï¸  mandb ëª…ë ¹ì´ ì—†ì–´ man DB ê°±ì‹ ì€ ê±´ë„ˆëœë‹ˆë‹¤."
    echo "     ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì„¤ì¹˜ í›„ ë°”ë¡œ 'man sshctl' ì´ ë™ì‘í•©ë‹ˆë‹¤."
  fi
}

# ----------------------------------------------------------------------
# main
# ----------------------------------------------------------------------
main() {
  echo "=================================================="
  echo " 'sshctl' ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸"
  echo " - sshctl ì‹¤í–‰íŒŒì¼ (í•­ìƒ ì„¤ì¹˜)"
  echo " - sshctl man pages (1/5/7, ì˜µì…˜)"
  echo " - sshctl bash completion (ì˜µì…˜)"
  echo "=================================================="
  echo " ì˜µì…˜:"
  echo "   -y : completion ë° man í˜ì´ì§€ë¥¼ ë¬»ì§€ ì•Šê³  ëª¨ë‘ ì„¤ì¹˜"
  echo

  check_dependencies

  # 1) sshctl ë³¸ì²´ëŠ” í•­ìƒ ì„¤ì¹˜
  if ! install_sshctl; then
    echo "âŒ sshctl ì„¤ì¹˜ ì‹¤íŒ¨. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤." >&2
    exit 1
  fi

  # 2) man pages (ì¡°ê±´ë¶€)
  maybe_install_man "1" "${SSHCTL_MAN1_URL}" "${MAN1_TEMP_FILE}" "${MAN1_TARGET_DIR}" "sshctl.1" "sshctl.1 (ê¸°ë³¸ ëª…ë ¹ man í˜ì´ì§€)"
  maybe_install_man "5" "${SSHCTL_MAN5_URL}" "${MAN5_TEMP_FILE}" "${MAN5_TARGET_DIR}" "sshctl-conf.5" "sshctl-conf.5 (ì„¤ì • íŒŒì¼ ì„¤ëª… man í˜ì´ì§€)"
  maybe_install_man "7" "${SSHCTL_MAN7_URL}" "${MAN7_TEMP_FILE}" "${MAN7_TARGET_DIR}" "sshctl-security.7" "sshctl-security.7 (ë³´ì•ˆ ì„¤ê³„ man í˜ì´ì§€)"

  # 3) man DB ê°±ì‹  (ì„¤ì¹˜ëœ man íŒŒì¼ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ)
  update_man_db_if_needed

  # 4) bash completion (ì¡°ê±´ë¶€)
  maybe_install_completion

  echo "--------------------------------------------------"
  echo "âœ¨ ì„¤ì¹˜ ì™„ë£Œ!"
  echo "  - sshctl ëª…ë ¹ ì‚¬ìš©: sshctl --help"
  echo "  - man í˜ì´ì§€ ì‚¬ìš© (ì„¤ì¹˜í•œ ê²½ìš°):"
  echo "      man sshctl"
  echo "      man sshctl-conf"
  echo "      man sshctl-security"
}

main

exit 0
