#!/usr/bin/env bash
#
# SSHCTL ë° SSHCTL.COMPLETION, man í˜ì´ì§€ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ê³  ì„¤ì¹˜í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
# - ì‹œìŠ¤í…œ ê¶Œí•œ(/etc, /usr/local/share/man)ì´ í•„ìš”í•˜ë©´ ìë™ìœ¼ë¡œ sudo ìš”ì²­
# - sshctl íŒŒì¼ì—ëŠ” ì‹¤í–‰ ê¶Œí•œ(chmod +x) ë¶€ì—¬

# ----------------------------------------------------------------------
# í”„ë¡œê·¸ë¨ íŒŒì¼ ì´ë¦„
# ----------------------------------------------------------------------
SSHCTL_FILENAME="sshctl"
SSHCTL_COMPLETION_FILENAME="${SSHCTL_FILENAME}.completion"

# ----------------------------------------------------------------------
# ì›ê²© URL ì •ì˜ (sshctl / completion / man pages)
# ----------------------------------------------------------------------
SSHCTL_SCRIPT_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/net/sshctl/${SSHCTL_FILENAME}"
SSHCTL_COMPLETION_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/net/sshctl/${SSHCTL_COMPLETION_FILENAME}"

# man page ì›ê²© ê²½ë¡œ
SSHCTL_MAN1_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/__.man/1/sshctl.1"
SSHCTL_MAN5_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/__.man/5/sshctl-conf.5"
SSHCTL_MAN7_URL="https://raw.githubusercontent.com/parkjunhong/shellscripts/refs/heads/main/__.man/7/sshctl-security.7"

# ----------------------------------------------------------------------
# ì„¤ì¹˜ ê²½ë¡œ ì •ì˜
# ----------------------------------------------------------------------
# sshctl ì‹¤í–‰ íŒŒì¼ ì„¤ì¹˜ ê²½ë¡œ
SSHCTL_TARGET_DIR="${HOME}/bin"

# bash completion ì„¤ì¹˜ ê²½ë¡œ
COMPLETION_TARGET_DIR="/etc/bash_completion.d"

# man í˜ì´ì§€ ì„¤ì¹˜ ê²½ë¡œ (ì„¹ì…˜ë³„)
MAN1_TARGET_DIR="/usr/local/share/man/man1"
MAN5_TARGET_DIR="/usr/local/share/man/man5"
MAN7_TARGET_DIR="/usr/local/share/man/man7"

# ----------------------------------------------------------------------
# ì„ì‹œ ë””ë ‰í† ë¦¬ ë° íŒŒì¼ ê²½ë¡œ
# ----------------------------------------------------------------------
TEMP_DIR="$(mktemp -d)"
SSHCTL_TEMP_FILE="${TEMP_DIR}/${SSHCTL_FILENAME}"
COMPLETION_TEMP_FILE="${TEMP_DIR}/${SSHCTL_COMPLETION_FILENAME}"
MAN1_TEMP_FILE="${TEMP_DIR}/sshctl.1"
MAN5_TEMP_FILE="${TEMP_DIR}/sshctl-conf.5"
MAN7_TEMP_FILE="${TEMP_DIR}/sshctl-security.7"

# ----------------------------------------------------------------------
# ê³µí†µ ìœ í‹¸ í•¨ìˆ˜ë“¤
# ----------------------------------------------------------------------

# -----------------------------------------------------------------------------
# í•¨ìˆ˜: cleanup
# ì„¤ëª…: ì„ì‹œ ë””ë ‰í† ë¦¬ ì •ë¦¬
# -----------------------------------------------------------------------------
cleanup() {
  if [[ -d "${TEMP_DIR}" ]]; then
    echo "ğŸ§¹ ì„ì‹œ íŒŒì¼ ì •ë¦¬: ${TEMP_DIR}"
    rm -rf "${TEMP_DIR}"
  fi
}

# ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ ì‹œ í•­ìƒ cleanup ìˆ˜í–‰
trap cleanup EXIT

# -----------------------------------------------------------------------------
# í•¨ìˆ˜: check_dependencies
# ì„¤ëª…: í•„ìš”í•œ ë„êµ¬(curl ë˜ëŠ” wget)ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
# -----------------------------------------------------------------------------
check_dependencies() {
  if command -v curl >/dev/null 2>&1; then
    DOWNLOADER="curl -fsSL"
  elif command -v wget >/dev/null 2>&1; then
    DOWNLOADER="wget -qO-"
  else
    echo "âŒ í•„ìˆ˜ ë„êµ¬ (curl ë˜ëŠ” wget)ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”." >&2
    exit 1
  fi
}

# -----------------------------------------------------------------------------
# í•¨ìˆ˜: ensure_dir
# ì„¤ëª…: ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ìƒì„± (í•„ìš”ì‹œ sudo)
# @param $1 {string} target_dir ìƒì„±/ë³´ì¥í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ
# -----------------------------------------------------------------------------
ensure_dir() {
  local target_dir="$1"

  if [[ -d "${target_dir}" ]]; then
    return 0
  fi

  # ì“°ê¸° ê°€ëŠ¥ ì—¬ë¶€ì— ë”°ë¼ mkdir ë˜ëŠ” sudo mkdir
  if mkdir -p "${target_dir}" 2>/dev/null; then
    return 0
  else
    echo "  â„¹ï¸ ë””ë ‰í† ë¦¬(${target_dir}) ìƒì„±ì— sudo ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤."
    if command -v sudo >/dev/null 2>&1; then
      sudo mkdir -p "${target_dir}" || {
        echo "  âŒ ë””ë ‰í† ë¦¬(${target_dir}) ìƒì„± ì‹¤íŒ¨." >&2
        return 1
      }
    else
      echo "  âŒ sudo ê°€ ì—†ì–´ ë””ë ‰í† ë¦¬(${target_dir})ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >&2
      return 1
    fi
  fi
}

# -----------------------------------------------------------------------------
# í•¨ìˆ˜: copy_and_set_permissions
# ì„¤ëª…: íŒŒì¼ì„ target_dir ë¡œ ë³µì‚¬í•˜ê³ , í•„ìš”í•˜ë©´ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
# @param $1 {string} source_file          ë³µì‚¬í•  ì›ë³¸ íŒŒì¼
# @param $2 {string} target_dir           ëŒ€ìƒ ë””ë ‰í† ë¦¬
# @param $3 {string} filename             ëŒ€ìƒ íŒŒì¼ ì´ë¦„
# @param $4 {string} needs_exec_permission "true" ì´ë©´ chmod +x ìˆ˜í–‰
# -----------------------------------------------------------------------------
copy_and_set_permissions() {
  local source_file="$1"
  local target_dir="$2"
  local filename="$3"
  local needs_exec_permission="$4"

  # ëŒ€ìƒ ë””ë ‰í† ë¦¬ ë³´ì¥
  ensure_dir "${target_dir}" || return 1

  local final_dest_path="${target_dir}/${filename}"

  # ê¸°ë³¸ cp ë˜ëŠ” sudo cp
  local cp_cmd="cp"
  if [[ -e "${final_dest_path}" && ! -w "${final_dest_path}" ]]; then
    cp_cmd="sudo cp"
  elif [[ ! -e "${final_dest_path}" && ! -w "${target_dir}" ]]; then
    cp_cmd="sudo cp"
  fi

  echo "  ğŸ“ ${source_file} â†’ ${final_dest_path} ë³µì‚¬ ì¤‘..."
  ${cp_cmd} "${source_file}" "${final_dest_path}"
  if [[ $? -ne 0 ]]; then
    echo "  âŒ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨: ${source_file} â†’ ${final_dest_path}" >&2
    return 1
  fi
  echo "  âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ"

  # ì‹¤í–‰ ê¶Œí•œì´ í•„ìš”í•œ ê²½ìš°
  if [[ "${needs_exec_permission}" == "true" ]]; then
    local chmod_cmd="chmod +x"

    if [[ ! -w "${final_dest_path}" ]]; then
      chmod_cmd="sudo chmod +x"
    fi

    echo "  ğŸ”‘ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì¤‘..."
    ${chmod_cmd} "${final_dest_path}"
    if [[ $? -ne 0 ]]; then
      echo "  âŒ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì‹¤íŒ¨: ${final_dest_path}" >&2
      return 1
    fi
    echo "  âœ… ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬ ì™„ë£Œ"
  fi

  return 0
}

# -----------------------------------------------------------------------------
# í•¨ìˆ˜: download_files
# ì„¤ëª…: sshctl / completion / man í˜ì´ì§€ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
# -----------------------------------------------------------------------------
download_files() {
  echo "ğŸš€ [ë‹¤ìš´ë¡œë“œ ì‹œì‘]"

  # sshctl
  echo "  âš™ï¸ sshctl ë‹¤ìš´ë¡œë“œ ì¤‘: ${SSHCTL_SCRIPT_URL}"
  ${DOWNLOADER} "${SSHCTL_SCRIPT_URL}" > "${SSHCTL_TEMP_FILE}"
  if [[ $? -ne 0 || ! -s "${SSHCTL_TEMP_FILE}" ]]; then
    echo "  âŒ sshctl ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨." >&2
    return 1
  fi

  # completion
  echo "  âš™ï¸ sshctl.completion ë‹¤ìš´ë¡œë“œ ì¤‘: ${SSHCTL_COMPLETION_URL}"
  ${DOWNLOADER} "${SSHCTL_COMPLETION_URL}" > "${COMPLETION_TEMP_FILE}"
  if [[ $? -ne 0 || ! -s "${COMPLETION_TEMP_FILE}" ]]; then
    echo "  âŒ sshctl.completion ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨." >&2
    return 1
  fi

  # man1
  echo "  ğŸ“– sshctl.1(man1) ë‹¤ìš´ë¡œë“œ ì¤‘: ${SSHCTL_MAN1_URL}"
  ${DOWNLOADER} "${SSHCTL_MAN1_URL}" > "${MAN1_TEMP_FILE}"
  if [[ $? -ne 0 || ! -s "${MAN1_TEMP_FILE}" ]]; then
    echo "  âŒ sshctl.1 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨." >&2
    return 1
  fi

  # man5
  echo "  ğŸ“– sshctl-conf.5(man5) ë‹¤ìš´ë¡œë“œ ì¤‘: ${SSHCTL_MAN5_URL}"
  ${DOWNLOADER} "${SSHCTL_MAN5_URL}" > "${MAN5_TEMP_FILE}"
  if [[ $? -ne 0 || ! -s "${MAN5_TEMP_FILE}" ]]; then
    echo "  âŒ sshctl-conf.5 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨." >&2
    return 1
  fi

  # man7
  echo "  ğŸ“– sshctl-security.7(man7) ë‹¤ìš´ë¡œë“œ ì¤‘: ${SSHCTL_MAN7_URL}"
  ${DOWNLOADER} "${SSHCTL_MAN7_URL}" > "${MAN7_TEMP_FILE}"
  if [[ $? -ne 0 || ! -s "${MAN7_TEMP_FILE}" ]]; then
    echo "  âŒ sshctl-security.7 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨." >&2
    return 1
  fi

  echo "  âœ… ëª¨ë“  íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì™„ë£Œ (${TEMP_DIR})"
  return 0
}

# -----------------------------------------------------------------------------
# í•¨ìˆ˜: install_sshctl
# ì„¤ëª…: sshctl ì‹¤í–‰ íŒŒì¼ ì„¤ì¹˜
# -----------------------------------------------------------------------------
install_sshctl() {
  echo "--------------------------------------------------"
  echo "ğŸ“¦ sshctl ì„¤ì¹˜ ê²½ë¡œ: ${SSHCTL_TARGET_DIR}"

  copy_and_set_permissions "${SSHCTL_TEMP_FILE}" "${SSHCTL_TARGET_DIR}" "${SSHCTL_FILENAME}" "true" || return 1

  echo "  â„¹ï¸ PATH ì— ${SSHCTL_TARGET_DIR} ê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
  echo "     ì˜ˆ) export PATH=\"${SSHCTL_TARGET_DIR}:\$PATH\""

  return 0
}

# -----------------------------------------------------------------------------
# í•¨ìˆ˜: install_completion
# ì„¤ëª…: bash completion ìŠ¤í¬ë¦½íŠ¸ ì„¤ì¹˜
# -----------------------------------------------------------------------------
install_completion() {
  echo "--------------------------------------------------"
  echo "ğŸ“¦ sshctl bash completion ì„¤ì¹˜ ê²½ë¡œ: ${COMPLETION_TARGET_DIR}"

  copy_and_set_permissions "${COMPLETION_TEMP_FILE}" "${COMPLETION_TARGET_DIR}" "${SSHCTL_COMPLETION_FILENAME}" "false" || return 1

  echo "  â„¹ï¸ bash ì—ì„œ ìë™ì™„ì„±ì„ í™œì„±í™”í•˜ë ¤ë©´ í„°ë¯¸ë„ì„ ìƒˆë¡œ ì—´ê±°ë‚˜,"
  echo "     ë‹¤ìŒ ëª…ë ¹ ì¤‘ í•˜ë‚˜ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”:"
  echo "       - source ~/.bashrc"
  echo "       - source ${COMPLETION_TARGET_DIR}/${SSHCTL_COMPLETION_FILENAME}"

  return 0
}

# -----------------------------------------------------------------------------
# í•¨ìˆ˜: install_manpages
# ì„¤ëª…: man í˜ì´ì§€(1/5/7) ì„¤ì¹˜ ë° man DB ê°±ì‹ 
# -----------------------------------------------------------------------------
install_manpages() {
  echo "--------------------------------------------------"
  echo "ğŸ“š man í˜ì´ì§€ ì„¤ì¹˜ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤."

  # ì„¹ì…˜ë³„ ë””ë ‰í† ë¦¬ ë³´ì¥
  ensure_dir "${MAN1_TARGET_DIR}" || return 1
  ensure_dir "${MAN5_TARGET_DIR}" || return 1
  ensure_dir "${MAN7_TARGET_DIR}" || return 1

  # ê° ì„¹ì…˜ì— ë³µì‚¬
  echo "  ğŸ“– sshctl.1 â†’ ${MAN1_TARGET_DIR}"
  copy_and_set_permissions "${MAN1_TEMP_FILE}" "${MAN1_TARGET_DIR}" "sshctl.1" "false" || return 1

  echo "  ğŸ“– sshctl-conf.5 â†’ ${MAN5_TARGET_DIR}"
  copy_and_set_permissions "${MAN5_TEMP_FILE}" "${MAN5_TARGET_DIR}" "sshctl-conf.5" "false" || return 1

  echo "  ğŸ“– sshctl-security.7 â†’ ${MAN7_TARGET_DIR}"
  copy_and_set_permissions "${MAN7_TEMP_FILE}" "${MAN7_TARGET_DIR}" "sshctl-security.7" "false" || return 1

  # man ë°ì´í„°ë² ì´ìŠ¤ ê°±ì‹  (ìˆì„ ë•Œë§Œ)
  if command -v mandb >/dev/null 2>&1; then
    echo "  ğŸ”„ man DB ê°±ì‹  ì¤‘ (mandb)..."
    if mandb >/dev/null 2>&1; then
      echo "  âœ… man DB ê°±ì‹  ì™„ë£Œ"
    else
      echo "  âš ï¸ mandb ì‹¤í–‰ì— ì‹¤íŒ¨í–ˆì§€ë§Œ, man í˜ì´ì§€ëŠ” íŒŒì¼ ìˆ˜ì¤€ì—ì„œëŠ” ì„¤ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤." >&2
    fi
  else
    echo "  â„¹ï¸ mandb ëª…ë ¹ì´ ì—†ì–´ man DB ê°±ì‹ ì€ ê±´ë„ˆëœë‹ˆë‹¤."
    echo "     ëŒ€ë¶€ë¶„ì˜ ê²½ìš° ì„¤ì¹˜ í›„ ë°”ë¡œ 'man sshctl' ì´ ë™ì‘í•©ë‹ˆë‹¤."
  fi

  echo "  âœ… man í˜ì´ì§€ ì„¤ì¹˜ ì™„ë£Œ"
  return 0
}

# ----------------------------------------------------------------------
# main í•¨ìˆ˜
# ----------------------------------------------------------------------
main() {
  echo "=================================================="
  echo " SSHCTL ì„¤ì¹˜ ìŠ¤í¬ë¦½íŠ¸"
  echo " - sshctl ì‹¤í–‰íŒŒì¼"
  echo " - sshctl bash completion"
  echo " - sshctl man pages (1/5/7)"
  echo "=================================================="

  # 1. ì˜ì¡´ì„± í™•ì¸
  check_dependencies

  # 2. íŒŒì¼ ë‹¤ìš´ë¡œë“œ
  if ! download_files; then
    echo "âŒ ë‹¤ìš´ë¡œë“œ ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„¤ì¹˜ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤." >&2
    exit 1
  fi

  # 3. sshctl ì„¤ì¹˜
  if ! install_sshctl; then
    echo "âŒ sshctl ì„¤ì¹˜ ì‹¤íŒ¨." >&2
    exit 1
  fi

  # 4. completion ì„¤ì¹˜
  if ! install_completion; then
    echo "âŒ sshctl completion ì„¤ì¹˜ ì‹¤íŒ¨." >&2
    exit 1
  fi

  # 5. man í˜ì´ì§€ ì„¤ì¹˜
  if ! install_manpages; then
    echo "âŒ man í˜ì´ì§€ ì„¤ì¹˜ ì‹¤íŒ¨." >&2
    exit 1
  fi

  echo "--------------------------------------------------"
  echo "âœ¨ ì„¤ì¹˜ ì™„ë£Œ!"
  echo "  - sshctl ëª…ë ¹ ì‚¬ìš©: sshctl --help"
  echo "  - man í˜ì´ì§€ ì‚¬ìš©:"
  echo "      man sshctl"
  echo "      man sshctl-conf"
  echo "      man sshctl-security"
}

# ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
main

exit 0
