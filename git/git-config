#!/usr/bin/env bash
set -euo pipefail

# =======================================
# @author : parkjunhong77@gmail.com
# @title  : git config user.name & user.email
# @license: Apache License 2.0
# @since  : 2020-09-15
# =======================================

SCRIPT_NAME="$(basename "$0")"

usage() {
  local called_by="${1:-}"
  echo
  if [ -n "$called_by" ]; then
    echo ">>> CALLED BY [[ $called_by ]]"
    echo
  fi
  echo "[Usage]"
  echo
  echo "  $SCRIPT_NAME -u <user.name> -e <user.email>"
  echo "  $SCRIPT_NAME --username <user.name> --useremail <user.email>"
  echo "  $SCRIPT_NAME -h | --help"
  echo
  echo "[Parameter]"
  echo "  -u, --username   : user.name"
  echo "  -e, --useremail  : user.email"
  echo
  echo "[Option]"
  echo "  -h, --help       : 도움말"
  echo
}

die() {
  echo "ERROR: $*" >&2
  echo >&2
  usage "error"
  exit 1
}

need_arg() {
  # $1: option name
  # $2: next token (maybe empty)
  local opt="$1"
  local val="${2:-}"
  if [ -z "$val" ]; then
    die "옵션 '$opt' 는 값이 필요합니다."
  fi
}

NAME=""
EMAIL=""

# 파라미터 읽기
while [ $# -gt 0 ]; do
  case "$1" in
    -u|--username)
      need_arg "$1" "${2:-}"
      NAME="$2"
      shift 2
      ;;
    -e|--useremail)
      need_arg "$1" "${2:-}"
      EMAIL="$2"
      shift 2
      ;;
    -h|--help)
      usage "--help"
      exit 0
      ;;
    --)
      # 더 이상 옵션 파싱하지 않음
      shift
      break
      ;;
    -*)
      die "알 수 없는 옵션: $1"
      ;;
    *)
      die "알 수 없는 인자: $1"
      ;;
  esac
done

if [ -z "$NAME" ] && [ -z "$EMAIL" ]; then
  die "최소 하나의 옵션(-u 또는 -e)이 필요합니다."
fi

# git 존재 여부 확인
command -v git >/dev/null 2>&1 || die "git 명령을 찾을 수 없습니다."

# 실제 적용
if [ -n "$NAME" ]; then
  echo "git config user.name $NAME"
  git config user.name "$NAME"
fi

if [ -n "$EMAIL" ]; then
  echo "git config user.email $EMAIL"
  git config user.email "$EMAIL"
fi

echo
exit 0

